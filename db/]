package db

import (
	"crypto/md5"
	"fmt"
	"github.com/giskook/insurance/base"
	"io"
)

const (
	SQL_GET_USER_INFO string = "select  picc_user.name from picc_user where $1"
)

func (db_socket *DBSocket) gen_auth(entity_name string, can_add int, can_read int, can_del int, can_update int) string {
	auth := 0
	if can_add == 1 {
		auth |= 8
	}
	if can_read == 1 {
		auth |= 4
	}

	if can_del == 1 {
		auth |= 2
	}

	if can_update == 1 {
		auth |= 1
	}

	return entity_name + "." + fmt.Sprintf("%d", auth)
}

func (db_socket *DBSocket) combine_auth(auth1 string, auth2 string) string {
	return auth1 + "-" + auth2
}

func (db_socket *DBSocket) ValidUser(user string, password string) (string, string, error) {
	rows, err := db_socket.db.Query(SQL_GET_USER, user)
	if err != nil {
		return "", "", err
	}
	defer rows.Close()

	var id, name, passwd, role_name, entity_name, auth string
	var can_add, can_read, can_del, can_update int

	if rows.Next() {
		if err := rows.Scan(&id, &name, &passwd, &role_name, &entity_name, &can_add, &can_read, &can_del, &can_update); err != nil {
			return "", "", err
		}
		if db_socket.valid_passwd(password, db_socket.conf.Secret, passwd) {
			auth = db_socket.gen_auth(entity_name, can_add, can_read, can_del, can_update)
		} else {
			return "", "", base.ErrLoginPasswdError
		}
	} else {
		return "", "", base.ErrLoginUserNotFound
	}

	for rows.Next() {
		if err := rows.Scan(&id, &name, &passwd, &role_name, &entity_name, &can_add, &can_read, &can_del, &can_update); err != nil {
			return "", "", err
		}
		auth_tmp := db_socket.gen_auth(entity_name, can_add, can_read, can_del, can_update)
		auth = db_socket.combine_auth(auth, auth_tmp)
	}

	if err := rows.Err(); err != nil {
		return "", "", err
	}

	return auth, id, nil
}
